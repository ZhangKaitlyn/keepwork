<template>
  <div class="lesson-menu">
    <div width="460px" center="">
      <div class="select-title">{{$t('lesson.linkThePage')}}</div>
      <el-select v-model="selectValue" class="select-options" :disabled="isLinked" filterable :placeholder="$t('lesson.pleaseSelect')">
        <el-option v-for="item in selectList" :key="item.id" :label="item.lessonName" :value="item.id">
        </el-option>
      </el-select>
      <div class="button-wrap">
        <el-button type="primary" @click="showEditorDialog" :loading="isLoading">{{$t('lesson.edit')}}</el-button>
        <transition name="el-zoom-in-top">
          <el-button v-show="isLinked" @click.stop="handleRelease">{{$t('lesson.release')}}</el-button>
        </transition>
      </div>
    </div>
    <el-dialog :visible.sync="dialogVisible" width="800px" :append-to-body="true" top="0">
      <edit-lesson v-if="dialogVisible" :isEditorMod="true" :lessonId="selectValue" @cancel="hideDialog" @refresh="this.checkMarkdownIsLinked"></edit-lesson>
    </el-dialog>
  </div>
</template>


<script>
import EditLesson from '@/components/lesson/teacher/EditLesson'

import { lesson } from '@/api'
import { mapGetters, mapActions } from 'vuex'
import _ from 'lodash'
export default {
  components: {
    EditLesson
  },
  async mounted() {
    await this.getUserLessons()
    await this.checkMarkdownIsLinked()
  },
  data() {
    return {
      dialogVisible: false,
      isLoading: false,
      lessonId: '',
      selectValue: '',
      selectLesson: {},
      userLessons: []
    }
  },
  computed: {
    ...mapGetters({
      activePage: 'activePage',
      activePageUrl: 'activePageUrl'
    }),
    userLessonsFilter() {
      return _.filter(this.userLessons, ({ url }) => !url)
    },
    selectList() {
      return this.isLinked ? this.userLessons : this.userLessonsFilter
    },
    isLinked() {
      return !!_.find(this.userLessons, ({ id }) => id === this.lessonId)
    }
  },
  methods: {
    async getUserLessons() {
      let lessons = await lesson.lessons.getUserLessons()
      this.userLessons = _.get(lessons, 'rows')
    },
    async checkMarkdownIsLinked() {
      let origin = window.location.origin
      if (origin === 'http://127.0.0.1:7001') {
        origin = 'https://stage.keepwork.com'
      }
      await lesson.lessons
        .lessonDetailByUrl({ url: `${origin}${this.activePageUrl}` })
        .then(res => {
          this.lessonId = res.id
          this.selectValue = res.id
          this.isShow = true
        })
        .catch(e => {
          console.error(e)
        })
    },
    async handleRelease() {
      const { file: { content } } = this.activePage
      await lesson.lessons
        .release({ id: this.selectValue, content })
        .then(res =>
          this.$message({
            type: 'success',
            message: this.$t('common.success')
          })
        )
        .catch(e => {
          console.error(e)
          this.$message.error(this.$t('common.success'))
        })
    },
    showDialog() {
      this.dialogVisible = true
    },
    hideDialog() {
      this.dialogVisible = false
    },
    async showEditorDialog() {
      if (!this.selectValue) {
        return this.$message.error(this.$t('lesson.pleaseSelect'))
      }
      this.dialogVisible = true
    }
  }
}
</script>

<style lang="scss">
.lesson-menu {
  margin-top: 20px;
  .select-title {
    text-align: center;
    color: #303133;
    font-size: 18px;
    font-weight: bold;
  }
  .select-desc {
    color: #909399;
    margin-top: 10px;
  }
  .select-options {
    margin-top: 10px;
    width: 100%;
  }
  .button-wrap {
    margin-top: 10px;
    text-align: right;
  }
}
</style>


